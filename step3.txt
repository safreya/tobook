docpath=$1
baseurl="https://github.com/FreeBSD-Ask/"
case $docpath in
	FreeBSD-Ask|Handbook|porter-handbook)
		echo "check $docpath update ..."
		;;
	*)
		echo "doc $docpath not exist"
		return
	;;
esac

odir=`pwd`
tempdir=${odir}/${docpath}_temp
docdir=$odir/$docpath

echo -e "\e[1;32m prepare *.tex file for $docpath \e[0m"
read -p "press [Enter] to begin ? " pausenow

mkdir -p $tempdir/.gitbook
mkdir -p $tempdir/onetex/.gitbook
mkdir -p $tempdir/pdf

ln -s $docdir/.gitbook/assets $tempdir/.gitbook/assets
ln -s $docdir/.gitbook/assets $tempdir/onetex/.gitbook/assets

grep -o "([^(]*)\s*$" $docpath/mu-lu.md | sed -e 's/^(//' -e 's/)$//' |grep -v "mu-lu.md" > $tempdir/list
echo "FreeBSD 从入门到跑路" > $tempdir/chapter
grep -o "##.*" $docpath/mu-lu.md|sed  -e "s/.*章[[:space:]]*//" >> $tempdir/chapter 

cat /dev/null > $tempdir/onetex/temp.tex 
count=1
while IFS= read -r line;do
	eval "ch$count=\"$line\""
	count=$((count+1))
done < $tempdir/chapter

count=1
curchapter="none"

while read line
do
	subdir=$(dirname $line)
	file=$(basename $line)
	cd $docdir/$subdir
	mkdir -p $tempdir/$subdir
	# cmark-gfm -t latex -e table $file > $tempdir/$subdir/temp.tex 
	if [ $curchapter != $subdir ];then
		#
		var="ch$count"
		eval "cname=\"\${$var}\""
		echo "\\chapter{$cname}" >> $tempdir/onetex/temp.tex
		curchapter="$subdir"
		count=$(($count + 1))
	fi
	cmark-gfm -t latex -e table $file >> $tempdir/onetex/temp.tex 
	cd $tempdir/$subdir
	cp $odir/wrap.tex $file.tex
	# xelatex $file.tex
	# xelatex $file.tex
	# cp $file.pdf $tempdir/pdf/$file.pdf
	cd $odir
done < $tempdir/list
	cd $tempdir/onetex
	cp $odir/wrap.tex ./

